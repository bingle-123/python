# 概述

## 分层
协议按照不同层次进行开发,每一层负责不同的通信功能.协议族(例如TCP/IP)由不同层次的多个协议组合.TCP/IP通常被认为是一个四层协议的系统:`应用层(telnet,ftp,e-mail等)-->运输层(TCP,UDP)-->网络层(IP,ICMP和ICMP)-->链路层(设备驱动程序及接口卡)`

每一层的功能:
- 链路层:也叫数据链路层或网络接口层,他们一起处理与电缆的无力接口细节
- 网络层:也叫互联网层,处理分组在网络中的活动,例如分组的选路.在TCP/IP协议族中,网络层协议包括IP协议(网际协议),ICMP协议(互联网控制报文协议),IGMP协议(组管理协议)
- 运输层:主要为两台主机上的应用程序提供端到端的通信.在TCP/IP协议族中.有两个互不相同的传输协议:TCP(传输控制协议)和UDP(用户数据协议)
    - TCP:用两台主机提供高可靠性的数据通信.它所做的工作包括把应用程序交给它的数据**分成合适的小块**交给网络层,确认接收到分组,设置发送最后确认分组的超时时钟等.由于运输层提供了高可靠性的端到端的通信,因此应用层可以忽略所有这些细节.
    - UDP:它只把数据包分组从一台主机发送到另一台主机,但不保证该数据报能够最终到达另一台主机.
- 应用层:负责处理特定的应用程序细节

**内核负责处理(运输层-->网络层-->链路层)**

**路由器(IP 路由器)**:为不同类型的无力网络提供连接:以太网,令牌环网,点对点连接和FDDI(光线分布式数据接口)等等.路由器提供网络层(例如:IP)协议和链路层协议.

IP是不可靠的服务,只负责尽可能快的把分组从源发送到目的地.而TCP建立在IP之上,并且提供可靠性,所以他通过超时重发,发送和接受端到端的确认分组等机制

**网桥**:在链路层上对网络进行互联,而路由器是在网络层上对网络进行互联,网桥使得多个局域网组合在一起,这样对于上层来说就好像是一个局域网

## TCP/IP的分层
- TCP--UDP
- ICMP--IP--IGMP
- ARP--硬件接口---RARP

应用程序也可以直接访问ICMP,IP

## 互联网地址

互联网的每个接口都必须有一个唯一的地址IP,地址具有5种结构类型

- A: `0[7位:网络号][24位:主机号]` 范围:`0.0.0.0~127.255.255.255`
- B: `10[14位:网络号][16位:主机号]` 范围:`128.0.0.0~191.255.255.255`
- C: `110[21位:网络号][8位:主机号]` 范围:`192.0.0.0~223.255.255.255`
- D: `1110[28位:多播组号]` 范围:`224.0.0.0~239.255.255.255`
- E: `11110[27位:留待后用]` 范围:`240.0.0.0~247.255.255.255`

区分地址类型用前5位就可以,或者用10地址第一段

有3类IP:单播地址(目的地位单个主机),广播地址(目的端位给定网络上的所有主机),多播地址(目的地位同一组内的所有主机)

## 域名系统
域名系统DNS是一个分布式的数据库,由它来提供IP地址和主机名之间的映射信息.

任何应用程序都以调用一个标准的库函数来查看给定名字的主机IP或者给定IP获取主机名

## 封装

应用程序使用TCP传送数据,数据进入协议栈,然后通过每一层直到被当做一串比特流传入网络,其中每一层对收到的数据都要加一些首部信息(有时还要加尾部信息)

- (TCP报文段简称TCP段 tcp segment) TCP--->IP
- (IP数据报 IP datagram) IP--->网络接口
- (比特流帧 Frame) 网络接口--->以太网

以太网数据帧的长度**46~4500字节**

- 用户数据
- TCP首部+用户数据
- IP首部+TCP首部+用户数据
- 以太网首部+IP首部+TCP首部+用户数据+以太网尾部

TCP,UDP,ICMP,IGMP都要向IP传送数据,因此IP必须在生成的IP首部加某种标志,表明数据属于哪一层.**IP首部存入一个长度为8bit的数值-->协议域**,1表示ICMP,2表示IGMP,6表示TCP,17表示UDP

TCP,UDP首部要区分不同应用程序,**他们使用16bit的端口号表示不同的应用程序0~65535**,TCP把源端口号和目的端口号分别存入报文首部中

网络层要分别发送和接受IP,ARP和RARP数据,因此也必须在以太网的帧首部加入标志,以表明生成数据的网络层协议(与IP层类似),使用**16bit的帧类型域(IP使用8bit)**

## 分用

当目的主机接收到以外网数据时,数据就开始从协议栈底部向上一层层去掉报文首部.

## 应用编程接口

使用TCP/IP协议的应用程序通常采用两种应用编程接口:socket和TLI(运输层口)

## 总结

构造互联网的共同基石是路由器,他们在IP层把网络连接一起




# 链路层

## 引言

链路层主要有三个目的:
- 为IP模块发送和接受IP数据包
- 为ARP模块发送arp请求和接受arp应答
- 为RARP模块发送rarp请求和接受rarp应答

## 以太网和IEEE 802封装


# IP:网际协议

IP是TCP/IP协议族中最为核心的协议,所有TCP,UDP,ICMP,IGMP都以IP数据报格式传输.

IP仅提供最好的传输服务,但是不保证数据能成功发送到目的地.发生错误时,例如路由缓存不足,IP有一个简单的错误处理算法,丢弃该数据,然后发送icmp消息报给信源端.**任何可靠性必须由上层提供,例如TCP**

**无连接**意思是IP不维护任何关于后续数据报的状态信息.每个数据报的处理都是相互独立的.**也就是说IP数据包可以不按顺序接收**,所以B可能在A之前接收到.因为数据报都是独立的进行路由选择

## IP首部

[4位:版本][4位:首部长度][8位:服务类型(TOS)][16位总长度(字节数)]-->4字节

[16位:标识][3位:标志][13位:片偏移]-->4字节

[8位:生存时间(TTL][8位:协议][16位:首部检验和]-->4字节

[32位:信源IP地址]-->4字节

[32位:目的IP地址]-->4字节

[选项(如果有)]

[数据]


- 版本号:目前是4,还有6
- 首部长度,单位是4字节,所以表示的方位是0~60字节(0~15)*4,如果没有选项的话,该值是5
- 服务类型:3位:优先权自字段(现在已被忽略);4位:TOS字段;1位:未用但是必须是0. TOS每位分别是:最小时延,最大吞吐量,最高可靠性,最小费用,**只能设置其中一位为1**,如果4位都是0,表示是一般服务.
> 不同应用的建议TOS为
> - telnet/rlogin 1000
> - FTP 控制 1000
> - FTP 数据 0100
> - 任意块数据 0100
> - TFTP 1000
> - SMTP 命令阶段 1000
> - SMTP 数据阶段 0100
> - DNS UDP查询 1000
> - DNS TCP 查询 0000
> - DNS 区域传输 0100
> - ICMP 差错 0000
> - ICMP 查询 0000
> - ICMP 任何IGP 0010
> - SNMP 0010
> - BOOTP 0000
> - NNTP 0001

> 大多数实现都不允许设置TOS字段

- 总长度是指整个IP数据包长度,以字节为单位,利用首部长度字段和总长度字段,由于该字段16位,所以IP数据包长度最大为65535字节,但是通常大小是512~576字节限制,因为链路层需要将他分片,分片之后的数据,有些可能小于512,那么链路层会填充一些数据
- TTL生存时间:设置了数据包可以经过的最多路由器数.TTL初始值由源主机设置(通常是32或64),一旦经过一个处理他的路由器,他的值就会减1.当该字段值为0时,数据报就被丢弃,并发送ICMP报文通知源主机
- 协议字段:区分IP数据报
- 首部检验和,首先把检验和字段设置为0,然后对首部中每个16bit进行二进制反码求和(整个首部看成是一串16bit字组成),结果存在检验和字段中.当收到一份IP数据报后,同样对首部每个16bit进行二进制反码求和
